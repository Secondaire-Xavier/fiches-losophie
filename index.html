<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestionnaire de Cours de Philosophie</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg, #fff5e6 0%, #ffe8cc 100%);
  margin: 0;
  padding: 0;
  min-height: 100vh;
}

.container {
  max-width: 950px;
  margin: auto;
  padding: 20px;
}

.card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.header h1 {
  margin-top: 0;
  color: #8B4000;
  text-align: center;
}

/* Section recherche am√©lior√©e */
.search-bar {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: stretch;
  margin-bottom: 20px;
  justify-content: center;
}

.search-input-wrapper {
  position: relative;
  flex: 1;
  min-width: 250px;
  max-width: 350px;
  display: flex;
  align-items: center;
}

.search-icon {
  position: absolute;
  left: 12px;
  font-size: 16px;
  pointer-events: none;
  color: #999;
}

.search-input-wrapper input {
  width: 100%;
  padding: 12px 12px 12px 40px;
  border: 2px solid #d7a96b;
  border-radius: 8px;
  font-size: 14px;
  transition: all 0.3s;
}

.search-input-wrapper input:focus {
  outline: none;
  border-color: #cc7a00;
  box-shadow: 0 0 0 3px rgba(204, 122, 0, 0.1);
}

.search-button {
  padding: 12px 24px;
  background: linear-gradient(135deg, #cc7a00 0%, #b36900 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
  white-space: nowrap;
}

.search-button:hover {
  background: linear-gradient(135deg, #b36900 0%, #9a5800 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(179, 105, 0, 0.3);
}

.add-button {
  padding: 12px 24px;
  background: linear-gradient(135deg, #228b22 0%, #1a6b1a 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
  white-space: nowrap;
}

.add-button:hover {
  background: linear-gradient(135deg, #1a6b1a 0%, #145214 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(34, 139, 34, 0.3);
}

.filters-section {
  background: #fafafa;
  border-radius: 8px;
  padding: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 15px;
  flex-wrap: wrap;
  border: 1px solid #f0f0f0;
  width: fit-content;
  vertical-align: middle;
}

.filters-label {
  font-size: 14px;
  color: #666;
  font-weight: 600;
}

.filter-checkbox {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
  position: relative;
  background-color: #d2d2d2;
  padding: 6px 10px;
  border-radius: 4px;
}

.filter-checkbox:hover {
  background-color: #c0c0c0;
}

.filter-checkbox input[type="checkbox"] {
  position: absolute;
  opacity: 0;
  cursor: pointer;
}

.checkbox-custom {
  width: 14px;
  height: 14px;
  border: 2px solid #d7a96b;
  border-radius: 3px;
  background: white;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.filter-checkbox input[type="checkbox"]:checked + .checkbox-custom {
  background: #cc7a00;
  border-color: #cc7a00;
}

.filter-checkbox input[type="checkbox"]:checked + .checkbox-custom::after {
  content: '‚úì';
  color: white;
  font-size: 12px;
  font-weight: bold;
}

.filter-label {
  font-size: 14px;
  color: #333;
  font-weight: 500;
}

.clear-button {
  padding: 8px 16px;
  background: #f5f5f5;
  color: #666;
  border: 1px solid #ddd;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.3s;
  white-space: nowrap;
  font-weight: 600;
}

.clear-button:hover {
  background: linear-gradient(135deg, #d8d8d8 0%, #d2d2d2 100%);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(229, 229, 229, 0.3);
}

.results-info {
  text-align: center;
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #f0f0f0;
}

.results-info p {
  margin: 0;
  color: #666;
  font-size: 14px;
  font-weight: 500;
}

.row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  justify-content: center;
}

.row2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.full {
  width: 100%;
  padding: 8px;
  box-sizing: border-box;
}

#addForm-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}

#addForm-content {
  background: white;
  border-radius: 8px;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  position: relative;
  padding: 0 20px 20px 20px;
}

input, textarea, select {
  border: 1px solid #d7a96b;
  padding: 8px;
  border-radius: 5px;
  font-family: inherit;
}

button {
  padding: 8px 12px;
  background: #cc7a00;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
}

button:hover {
  background: #a86300;
}

button.green { background: #228b22; }
button.green:hover { background: #186118; }

button.grey { background: #777; }
button.grey:hover { background: #555; }

button.red { background: #dc3545; }
button.red:hover { background: #c82333; }

button.blue { background: #007bff; }
button.blue:hover { background: #0056b3; }

.hidden { display: none; }

.tag {
  background: #ffe3b3;
  padding: 5px 10px;
  border-radius: 15px;
  margin: 3px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  cursor: pointer;
  transition: background 0.2s;
  font-size: 13px;
}

.tag:hover {
  background: #ffd280;
}

.tag.active {
  background: #ff9800;
  color: white;
}

.tag .remove {
  cursor: pointer;
  color: #a00;
  font-weight: bold;
}

.tag-container {
  margin-top: 10px;
}

.tag.small.author {
  background: #facbcb;
}

.tag.small.author:hover {
  background: #f4a5ad;
}

.tag.small.theme {
  background: #bfe3f1;
}

.tag.small.theme:hover {
  background: #9fd0e7;
}

.course-card {
  padding: 20px;
  background: white;
  border-radius: 8px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.3s;
  position: relative;
}

.course-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.course-card.highlight {
  box-shadow: 0 0 20px rgba(255, 152, 0, 0.5) !important;
}

.course-card h2 {
  margin: 0 0 10px;
  color: #8B4000;
  padding-right: 140px;
  font-size: 28px;
}

.course-id {
  font-size: 11px;
  color: #999;
  font-family: monospace;
  margin-right: 10px;
}

.course-actions {
  position: absolute;
  top: 15px;
  right: 15px;
  display: flex;
  gap: 8px;
}

.btn-icon {
  padding: 6px 10px;
  background: #e0e0e0;
  color: #333;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.btn-icon:hover {
  background: #d0d0d0;
}

.btn-icon.delete {
  background: #dc3545;
  color: white;
}

.btn-icon.delete:hover {
  background: #c82333;
}

.badges {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-bottom: 10px;
}

.course-type {
  display: inline-block;
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 10px;
  font-weight: bold;
}

.course-type.general {
  background: #e3f2fd;
  color: #1976d2;
}

.course-type.detailed {
  background: #f3e5f5;
  color: #7b1fa2;
}

.course-type.plan {
  background: #e8f5e9;
  color: #2e7d32;
}

.course-type.image {
  background: #fff3e0;
  color: #ef6c00;
}

/* Contenu tronqu√© */
.course-content {
  position: relative;
}

.course-content.truncated {
  max-height: 200px;
  overflow: hidden;
}

.course-content.truncated::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: linear-gradient(to bottom, transparent, white);
  pointer-events: none;
}

.expand-btn {
  margin-top: 10px;
  background: #f0f0f0;
  color: #333;
  padding: 6px 12px;
  font-size: 13px;
}

.expand-btn:hover {
  background: #e0e0e0;
}

.suggestions-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #d7a96b;
  border-top: none;
  border-radius: 0 0 5px 5px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  display: none;
}

.suggestions-dropdown.active {
  display: block;
}

.suggestion-item {
  padding: 8px;
  cursor: pointer;
  transition: background 0.2s;
}

.suggestion-item:hover {
  background: #fff3e6;
}

.image-container {
  margin-top: 10px;
  text-align: center;
}

.image-container img {
  max-width: 100%;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.links-section {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #eee;
}

.links-section h4 {
  margin: 0 0 8px 0;
  font-size: 13px;
  color: #666;
  display: inline-block;
}

.link-item {
  display: inline-block;
  background: #fff3e0;
  padding: 5px 10px;
  border-radius: 5px;
  margin: 3px;
  font-size: 13px;
  cursor: pointer;
  transition: background 0.2s;
}

.link-item:hover {
  background: #ffe0b2;
}

.link-type {
  font-size: 13px;
  color: #666;
  margin-right: 5px;
}

.editor-toolbar {
  background: #f5f5f5;
  padding: 8px;
  border-radius: 5px 5px 0 0;
  margin-top: 10px;
}

.editor-toolbar button {
  padding: 5px 10px;
  font-size: 12px;
  margin-right: 5px;
}

textarea.with-toolbar {
  border-radius: 0 0 5px 5px;
  margin-top: 0;
}

.link-input-group {
  margin-top: 15px;
}

.link-input-row {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
  align-items: center;
}

.link-input-row select {
  padding: 6px;
  border: 1px solid #d7a96b;
  border-radius: 5px;
  flex: 1;
}

.link-input-row input {
  flex: 0 0 100px;
}

.added-links {
  margin-top: 10px;
}

.added-link {
  background: #fff3e0;
  padding: 8px;
  border-radius: 5px;
  margin-bottom: 5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
}

.inline-link {
  background: #fff9c4;
  padding: 2px 6px;
  border-radius: 3px;
  cursor: pointer;
  color: #f57c00;
  font-weight: 500;
  transition: background 0.2s;
  text-decoration: none;
}

.inline-link:hover {
  background: #fff176;
}

.help-text {
  font-size: 12px;
  color: #666;
  margin-top: 5px;
  font-style: italic;
}

/* Modal pour afficher une fiche */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}

.modal-content {
  background: white;
  border-radius: 8px;
  min-width: 400px;
  max-width: 800px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  position: relative;
}

.modal-header {
  position: sticky;
  top: 0;
  background: white;
  padding: 15px 20px;
  border-bottom: 2px solid #f0f0f0;
  display: flex;
  justify-content: space-between;
  align-items: center;
  z-index: 10;
}

.modal-body {
  padding: 20px;
}

.modal-close {
  background: #dc3545;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
}

.modal-close:hover {
  background: #c82333;
}

/* Modal de pr√©visualisation */
.preview-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  padding: 15px 20px;
  border-top: 2px solid #f0f0f0;
  background: #f9f9f9;
  position: sticky;
  bottom: 0;
}

/* Citations d√©marqu√©es */
.citation-block {
  background: linear-gradient(to right, #fff9e6 0%, #fff9e6 4px, #fffbf0 4px);
  border-left: 4px solid #f39c12;
  padding: 15px 15px 15px 20px;
  margin: 15px 0;
  font-style: italic;
  border-radius: 0 5px 5px 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.citation-block::before {
  content: '"';
  font-size: 40px;
  color: #f39c12;
  position: absolute;
  margin-left: -15px;
  margin-top: -10px;
  opacity: 0.3;
}

/* √âditeur avec preview */
.editor-wrapper {
  position: relative;
}

.editor-preview {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  pointer-events: none;
  padding: 8px;
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
  white-space: pre-wrap;
  word-wrap: break-word;
  color: transparent;
  overflow: hidden;
}

.editor-preview span {
  color: #333;
}

.editor-preview .md-bold {
  font-weight: bold;
  color: #2c3e50;
}

.editor-preview .md-italic {
  font-style: italic;
  color: #34495e;
}

.editor-preview .md-underline {
  text-decoration: underline;
  color: #7f8c8d;
}

.editor-preview .md-citation {
  background: #fff9e6;
  color: #f39c12;
  font-style: italic;
}

textarea.with-preview {
  background: transparent;
  position: relative;
  z-index: 1;
  color: #333;
}
</style>
</head>

<body>
<div class="container">

  <div class="card header">
    <h1>üìö Gestionnaire de Cours de Philosophie</h1>
  </div>

  <div class="card">
    <!-- Barre de recherche principale -->
    <div class="search-bar">
      <div class="search-input-wrapper">
        <span class="search-icon">üîç</span>
        <input id="searchInput" type="text" placeholder="Rechercher par auteur, th√®me ou titre...">
      </div>
      <button id="searchBtn" class="search-button">Rechercher</button>
      <button id="clearFilters" class="clear-button">‚úñÔ∏è R√©initialiser</button>
      <button id="toggleAdd" class="add-button">‚ûï Ajouter une fiche</button>
    </div>
    
    <!-- Filtres par type -->
    <div style="display: flex; justify-content: center;">
    <div class="filters-section">
      <div class="filters-label">
        <strong>Filtrer par type:</strong>
      </div>
        <label class="filter-checkbox">
          <input type="checkbox" id="filterDetailed" checked>
          <span class="checkbox-custom"></span>
          <span class="filter-label">üìÑ D√©taill√©e</span>
        </label>
        <label class="filter-checkbox">
          <input type="checkbox" id="filterGeneral" checked>
          <span class="checkbox-custom"></span>
          <span class="filter-label">üìã G√©n√©raliste</span>
        </label>
        <label class="filter-checkbox">
          <input type="checkbox" id="filterPlan" checked>
          <span class="checkbox-custom"></span>
          <span class="filter-label">üìù Plan</span>
        </label>
        <label class="filter-checkbox">
          <input type="checkbox" id="filterImage" checked>
          <span class="checkbox-custom"></span>
          <span class="filter-label">üñºÔ∏è Image</span>
        </label>
    </div>
    </div>
    
    <!-- Tags de recherche actifs -->
    <div id="searchTags" class="tag-container"></div>

    <!-- Compteur de r√©sultats -->
    <div class="results-info">
      <p id="resultsCount"></p>
    </div>
  </div>

  <div id="addForm-overlay" style="display: none;">
    <div id="addForm-content" onclick="event.stopPropagation()">
    <div class="modal-header">
        <h2 id="formTitle">Ajouter une fiche</h2>
        <div>
          <button id="previewCourse" class="blue">üëÅÔ∏è Pr√©visualiser</button>
          <button id="cancelAdd" class="grey">‚úñÔ∏è Annuler</button>
        </div>
    </div>
    

    <div style="margin-bottom: 15px; margin-top: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Type de fiche:</label>
      <select id="courseType" class="full">
        <option value="detailed">üìÑ Fiche d√©taill√©e (analyse approfondie)</option>
        <option value="general">üìã Fiche g√©n√©raliste (vue d'ensemble)</option>
        <option value="plan">üìù Plan d√©taill√© (structure argumentative)</option>
        <option value="image">üñºÔ∏è Image (sch√©ma, carte mentale)</option>
      </select>
    </div>

    <div id="imageUploadSection" class="hidden" style="margin-bottom: 15px;">
      <label style="display: block; margin-bottom: 5px; font-weight: bold;">Image:</label>
      <input type="file" id="imageInput" accept="image/*" class="full">
      <div id="imagePreview" style="margin-top: 10px;"></div>
    </div>

    <input id="newTitle" type="text" placeholder="Titre du cours" class="full">

    <div class="editor-toolbar">
      <button type="button" id="boldBtn" title="Gras"><strong>B</strong></button>
      <button type="button" id="italicBtn" title="Italique"><em>I</em></button>
      <button type="button" id="underlineBtn" title="Soulign√©"><u>U</u></button>
      <button type="button" id="h3Btn" title="Titre">H3</button>
      <button type="button" id="citationBtn" title="Marquer comme citation">üí¨ Citation</button>
      <span style="border-left: 2px solid #ccc; height: 20px; margin: 0 8px;"></span>
      <button type="button" id="insertLinkBtn">üîó Lien</button>
      <span class="help-text">** gras ** | * italique * | __ soulign√© __ | <<< citation >>> | [lien inter-fiches]</span>
    </div>
    <div class="editor-wrapper">
      <div id="editorPreview" class="editor-preview"></div>
      <textarea id="newContent" placeholder="Contenu" rows="8" class="full with-toolbar with-preview"></textarea>
    </div>

    <div class="row2">
      <div>
        <h4>Auteurs</h4>
        <div class="row">
          <div style="position: relative; flex: 1;">
            <input id="newAuthor" type="text" placeholder="Auteur" style="width: 100%;" autocomplete="off">
            <div id="authorSuggestions" class="suggestions-dropdown"></div>
          </div>
          <button type="button" id="addAuthor">+</button>
        </div>
        <div id="authorsList" class="tag-container small"></div>
      </div>

      <div>
        <h4>Th√®mes</h4>
        <div class="row">
          <div style="position: relative; flex: 1;">
            <input id="newTheme" type="text" placeholder="Th√®me" style="width: 100%;" autocomplete="off">
            <div id="themeSuggestions" class="suggestions-dropdown"></div>
          </div>
          <button type="button" id="addTheme">+</button>
        </div>
        <div id="themesList" class="tag-container small"></div>
      </div>
    </div>

    <div class="link-input-group">
      <h4>üîó Liens vers d'autres fiches</h4>
      <div class="link-input-row">
        <select id="linkType">
          <option value="r√©pond √†">R√©pond √†</option>
          <option value="dans la continuit√© de">Dans la continuit√© de</option>
          <option value="s'oppose √†">S'oppose √†</option>
          <option value="compl√®te">Compl√®te</option>
          <option value="illustre">Illustre</option>
          <option value="critique">Critique</option>
        </select>
        <input id="linkTargetId" type="number" placeholder="ID">
        <button type="button" id="addLink">+ Ajouter</button>
      </div>
      <div id="addedLinks" class="added-links"></div>
    </div>
    </div>
  </div>

  <div id="courses"></div>

  <!-- Modal pour afficher une fiche -->
  <div id="modalOverlay" class="modal-overlay" style="display: none;" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 id="modalTitle"></h2>
        <button class="modal-close" onclick="closeModal()">‚úñ Fermer</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- Modal de pr√©visualisation avant sauvegarde -->
  <div id="previewOverlay" class="modal-overlay" style="display: none;">
    <div class="modal-content" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2>üëÅÔ∏è Pr√©visualisation</h2>
      </div>
      <div class="modal-body" id="previewBody"></div>
      <div class="preview-actions">
        <button class="blue" onclick="backToEditor()">‚úèÔ∏è Retour √† l'√©diteur</button>
        <button class="green" onclick="confirmSave()">üíæ Enregistrer d√©finitivement</button>
      </div>
    </div>
  </div>

</div>

<script>
// Donn√©es initiales (exemple minimal)
const initialCourses = [
  {
    id: 1,
    type: "detailed",
    title: "Pascal : La condition humaine et les limites de la raison",
    content: `Pascal √©tablit un constat s√©v√®re : l'homme est indiff√©rent aux questions existentielles importantes mais obs√©d√© par des choses futiles. L'homme est un **"roseau pensant"** - faible physiquement mais capable de pens√©e.

<<<La derni√®re d√©marche de la raison, c'est de reconna√Ætre qu'il y a une infinit√© de choses qui la surpassent.>>>

Voir aussi la suite de cette r√©flexion dans [2].`,
    authors: ["Pascal"],
    themes: ["Raison", "Conscience", "V√©rit√©"],
    links: [{type: "r√©pond √†", targetId: 2}]
  },
  {
    id: 2,
    type: "plan",
    title: "Plan : L'empirisme de Hume",
    content: `# I. Les impressions et les id√©es

Toute connaissance vient de l'exp√©rience sensible. Les **impressions** sont les perceptions vives (sensations), les **id√©es** sont leurs copies affaiblies.

# II. Critique de la causalit√©

La relation cause-effet n'est qu'une habitude mentale, pas une n√©cessit√© logique. Nous observons une succession constante, mais pas de lien n√©cessaire.

# III. Cons√©quences sceptiques

Si la causalit√© n'est qu'une croyance, nos connaissances scientifiques ne sont que probables, jamais certaines.`,
    authors: ["Hume"],
    themes: ["Raison", "Science", "V√©rit√©"],
    links: []
  }
];

// √âtat de l'application
let courses = [];
let searchTags = [];
let searchText = '';
let searchID = '';
let typeFilters = {
  detailed: true,
  general: true,
  plan: true,
  image: true
};
let newAuthors = [];
let newThemes = [];
let newLinks = [];
let editingId = null;
let expandedCourses = new Set(); // IDs des fiches d√©roul√©es

// Variables temporaires pour la pr√©visualisation
let previewData = null;

// Initialisation
try {
  const saved = localStorage.getItem('philosophyCourses');
  courses = saved ? JSON.parse(saved) : [...initialCourses];
} catch (e) {
  console.error('Erreur chargement:', e);
  courses = [...initialCourses];
}

// √âl√©ments DOM
const els = {
  searchInput: document.getElementById("searchInput"),
  searchBtn: document.getElementById("searchBtn"),
  clearFilters: document.getElementById("clearFilters"),
  filterDetailed: document.getElementById("filterDetailed"),
  filterGeneral: document.getElementById("filterGeneral"),
  filterPlan: document.getElementById("filterPlan"),
  filterImage: document.getElementById("filterImage"),
  searchTags: document.getElementById("searchTags"),
  courses: document.getElementById("courses"),
  resultsCount: document.getElementById("resultsCount"),
  addForm: document.getElementById("addForm-overlay"),
  formTitle: document.getElementById("formTitle"),
  toggleAdd: document.getElementById("toggleAdd"),
  cancelAdd: document.getElementById("cancelAdd"),
  courseType: document.getElementById("courseType"),
  citationFields: document.getElementById("citationFields"),
  imageUploadSection: document.getElementById("imageUploadSection"),
  imageInput: document.getElementById("imageInput"),
  imagePreview: document.getElementById("imagePreview"),
  newTitle: document.getElementById("newTitle"),
  newContent: document.getElementById("newContent"),
  newAuthor: document.getElementById("newAuthor"),
  authorSuggestions: document.getElementById("authorSuggestions"),
  newTheme: document.getElementById("newTheme"),
  themeSuggestions: document.getElementById("themeSuggestions"),
  addAuthor: document.getElementById("addAuthor"),
  addTheme: document.getElementById("addTheme"),
  authorsList: document.getElementById("authorsList"),
  themesList: document.getElementById("themesList"),
  linkType: document.getElementById("linkType"),
  linkTargetId: document.getElementById("linkTargetId"),
  addLink: document.getElementById("addLink"),
  addedLinks: document.getElementById("addedLinks"),
  previewCourse: document.getElementById("previewCourse"),
  insertLinkBtn: document.getElementById("insertLinkBtn"),
  citationBtn: document.getElementById("citationBtn"),
  boldBtn: document.getElementById("boldBtn"),
  italicBtn: document.getElementById("italicBtn"),
  underlineBtn: document.getElementById("underlineBtn"),
  h3Btn: document.getElementById("h3Btn"),
  modalOverlay: document.getElementById("modalOverlay"),
  modalTitle: document.getElementById("modalTitle"),
  modalBody: document.getElementById("modalBody"),
  previewOverlay: document.getElementById("previewOverlay"),
  previewBody: document.getElementById("previewBody")
};

// Sauvegarder
function saveCourses() {
  localStorage.setItem('philosophyCourses', JSON.stringify(courses));
}

// Compter les lignes de texte
function countLines(text) {
  return text.split('\n').length;
}

// Basculer l'expansion d'une fiche
window.toggleExpand = function(id) {
  if (expandedCourses.has(id)) {
    expandedCourses.delete(id);
  } else {
    expandedCourses.add(id);
  }
  renderCourses();
};

// Parser les liens [ID] dans le contenu
function parseContentLinks(content) {
  return content.replace(/\[(\d+)\]/g, (match, id) => {
    const course = courses.find(c => c.id === parseInt(id));
    const title = course ? course.title : `Fiche #${id}`;
    return `<a class="inline-link" onclick="scrollToCourse(${id})" title="${title}">#${id}</a>`;
  });
}

// Parser le markdown simple (gras, italique, soulign√©, titres, citations)
function parseMarkdown(text) {
  return text
    .replace(/<<<(.*?)>>>/gs, '<div class="citation-block">$1</div>')
    .replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>')
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/__(.*?)__/g, '<u>$1</u>')
    .replace(/^### (.+)$\n/gm, '<h3 style="color: #871c20; margin-bottom: 4px; font-size: 16px;">$1</h3>')
    .replace(/^## (.+)$\n/gm, '<h3 style="color: #2e437d; margin-bottom: 6px; font-size: 18px;">$1</h3>')
    .replace(/^# (.+)$\n/gm, '<h3 style="color: #2e7d32; margin-bottom: 8px; font-size: 20px;">$1</h3>');
}

// Scroller vers une fiche (maintenant en modal)
window.scrollToCourse = function(id) {
  const course = courses.find(c => c.id === id);
  if (!course) return;
  
  const typeLabels = {
    general: 'üìã Fiche g√©n√©raliste',
    detailed: 'üìÑ Fiche d√©taill√©e',
    plan: 'üìù Plan d√©taill√©',
    image: 'üñºÔ∏è Image'
  };
  
  els.modalTitle.textContent = course.title;
  
  let contentHtml = `
    <div class="course-type ${course.type || 'detailed'}">${typeLabels[course.type || 'detailed']}</div>
    <div class="course-id">ID: #${course.id}</div>
  `;
  
  contentHtml += `
    <div class="badges">
      ${course.authors.map(a => `<span class="tag small author">${a}</span>`).join("")}
    </div>
    <div class="badges">
      ${course.themes.map(t => `<span class="tag small theme">${t}</span>`).join("")}
    </div>
  `;
  
  if (course.type === 'image' && course.imageData) {
    contentHtml += `<div class="image-container"><img src="${course.imageData}" alt="${course.title}"></div>`;
    if (course.content) {
      contentHtml += `<div class="card-content" style="margin-top: 15px;">${parseMarkdown(parseContentLinks(course.content)).replace(/\n/g, "<br>")}</div>`;
    }
  } else {
    contentHtml += `<div class="card-content">${parseMarkdown(parseContentLinks(course.content)).replace(/\n/g, "<br>")}</div>`;
  }
  
  if (course.links && course.links.length > 0) {
    contentHtml += `
      <div class="links-section">
        <h4>üîó Liens:</h4>
        ${course.links.map(link => {
          const target = courses.find(c => c.id === link.targetId);
          const title = target ? target.title : `Fiche #${link.targetId}`;
          return `
            <div class="link-item" onclick="scrollToCourse(${link.targetId})">
              <span class="link-type">${link.type}</span>
              <strong>#${link.targetId}</strong> ${title}
            </div>
          `;
        }).join('')}
      </div>
    `;
  }
  
  els.modalBody.innerHTML = contentHtml;
  els.modalOverlay.style.display = 'flex';
};

window.closeModal = function(event) {
  if (!event || event.target === els.modalOverlay) {
    els.modalOverlay.style.display = 'none';
  }
};

window.closeModalForm = function(event) {
  if (!event || event.target === els.addForm) {
    els.addForm.style.display = 'none';
  }
};

// Fermer le modal de pr√©visualisation
window.closePreview = function(event) {
  if (!event || event.target === els.previewOverlay) {
    els.previewOverlay.style.display = 'none';
    previewData = null;
  }
};

// Retour √† l'√©diteur
window.backToEditor = function() {
  els.previewOverlay.style.display = 'none';
  els.addForm.style.display = 'flex';
};

// Confirmation de la sauvegarde
window.confirmSave = function() {
  if (!previewData) return;
  
  saveCourseData(
    previewData.title,
    previewData.content,
    previewData.type,
    previewData.imageData
  );
  
  els.previewOverlay.style.display = 'none';
  previewData = null;
  resetForm();
};

// Afficher les cours
function renderCourses() {
  const filtered = courses.filter(c => {
    // Filtre par type
    const typeMatch = typeFilters[c.type || 'detailed'];
    if (!typeMatch) return false;
    
    // Filtre par tags (auteurs/th√®mes)
    const tagMatch = searchTags.length === 0 ||
      searchTags.every(tag =>
        c.authors.some(a => a.toLowerCase() === tag.toLowerCase()) ||
        c.themes.some(t => t.toLowerCase() === tag.toLowerCase())
      );
    if (!tagMatch) return false;
    
    // Recherche textuelle dans le titre
    if (searchText) {
      const titleMatch = c.title.toLowerCase().includes(searchText.toLowerCase());
      const tagMatch = c.authors.some(a => a.toLowerCase().includes(searchText.toLowerCase())) ||
                       c.themes.some(t => t.toLowerCase().includes(searchText.toLowerCase()));
      if (!(titleMatch || tagMatch)) return false;
    }
    // Recherche par ID
    if (searchID) {
      if (c.id.toString() !== searchID) return false;
    }
    
    return true;
  });

  els.resultsCount.textContent = `${filtered.length} r√©sultat(s)`;

  if (filtered.length === 0) {
    els.courses.innerHTML = `<p style="text-align: center; color: #999; padding: 40px;">Aucune fiche ne correspond √† ces crit√®res.</p>`;
    return;
  }

  els.courses.innerHTML = filtered.map(c => {
    const typeClass = c.type || 'detailed';
    const typeLabels = {
      general: 'üìã Fiche g√©n√©raliste',
      detailed: 'üìÑ Fiche d√©taill√©e',
      plan: 'üìù Plan d√©taill√©',
      image: 'üñºÔ∏è Image'
    };
    const typeLabel = typeLabels[typeClass];
    
    let contentHtml = '';
    if (typeClass === 'image' && c.imageData) {
      contentHtml = `<div class="image-container"><img src="${c.imageData}" alt="${c.title}"></div>`;
      if (c.content) {
        contentHtml += `<div class="card-content" style="margin-top: 15px;">${parseMarkdown(parseContentLinks(c.content)).replace(/\n/g, "<br>")}</div>`;
      }
    } else {
      const fullContent = parseMarkdown(parseContentLinks(c.content)).replace(/\n/g, "<br>");
      const lines = countLines(c.content);
      const isExpanded = expandedCourses.has(c.id);
      
      if (lines > 12 && !isExpanded) {
        const truncatedContent = c.content.split('\n').slice(0, 8).join('\n');
        contentHtml = `
          <div class="card-content course-content truncated">
            ${parseMarkdown(parseContentLinks(truncatedContent)).replace(/\n/g, "<br>")}
          </div>
          <button class="expand-btn" onclick="toggleExpand(${c.id})">‚ñº Voir plus</button>
        `;
      } else if (lines > 12 && isExpanded) {
        contentHtml = `
          <div class="card-content course-content">
            ${fullContent}
          </div>
          <button class="expand-btn" onclick="toggleExpand(${c.id})">‚ñ≤ R√©duire</button>
        `;
      } else {
        contentHtml = `<div class="card-content">${fullContent}</div>`;
      }
    }
    
    let linksHtml = '';
    if (c.links && c.links.length > 0) {
      linksHtml = `
        <div class="links-section">
          <h4>üîó Liens:</h4>
          ${c.links.map(link => {
            const target = courses.find(course => course.id === link.targetId);
            const title = target ? target.title : `Fiche #${link.targetId}`;
            return `
              <div class="link-item" onclick="scrollToCourse(${link.targetId})">
                <span class="link-type">${link.type}</span>
                <strong>#${link.targetId}</strong> ${title}
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    return `
      <div class="course-card" id="course-${c.id}">
        <div class="course-actions">
          <button class="btn-icon" onclick="editCourse(${c.id})">‚úèÔ∏è</button>
          <button class="btn-icon delete" onclick="deleteCourse(${c.id})">üóëÔ∏è</button>
        </div>
        <div style="display: flex; justify-content: flex-start; align-items: center; margin-bottom: 8px;">
        <div class="course-type ${typeClass}" style="margin-right: 10px;">${typeLabel}</div>
        <div class="course-id">ID: #${c.id}</div>
        ${c.authors.map(a => `<span class="tag small author" onclick="addSearchTag('${a}')">${a}</span>`).join("")}
        ${c.themes.map(t => `<span class="tag small theme" onclick="addSearchTag('${t}')">${t}</span>`).join("")}
        </div>
        <h2>${c.title}</h2>

        ${contentHtml}
        
        ${linksHtml}
      </div>
    `;
  }).join("");
}

// Tags de recherche
function renderSearchTags() {
  els.searchTags.innerHTML = (
    searchTags.map(tag => `
      <span class="tag active">${tag}
        <span class="remove" onclick="removeTag('${tag}')">√ó</span>
      </span>
    `).join("") +
    (searchID ? `
      <span class="tag active">#${searchID}
        <span class="remove" onclick="removeTag(${searchID})">√ó</span>
      </span>
    ` : "")
  );
}

window.addSearchTag = function(tag) {
  if (!searchTags.includes(tag)) {
    searchTags.push(tag);
    renderSearchTags();
    renderCourses();
  }
};

window.removeTag = function(tag) {
  if (tag.toString() === searchID) {
    searchID = '';
    renderSearchTags();
    renderCourses();
    return;
  }
  searchTags = searchTags.filter(t => t !== tag);
  renderSearchTags();
  renderCourses();
};

els.searchBtn.onclick = () => search();
els.searchInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    search();
  }
});

function search() {
  const val = els.searchInput.value.trim();
  searchText = '';
  if (val) {
    // Si c'est un tag existant (auteur/th√®me), l'ajouter aux tags
    const allAuthors = getAllAuthors();
    const allThemes = getAllThemes();
    
    if (allAuthors.some(a => a.toLowerCase() === val.toLowerCase()) ||
        allThemes.some(t => t.toLowerCase() === val.toLowerCase())) {
      if (!searchTags.includes(val)) {
        searchTags.push(val);
        renderSearchTags();
      }
      els.searchInput.value = '';
    } else if (val.startsWith('#')) {
      // Si c'est de la forme #ID, chercher la fiche par ID
      searchID = val.slice(1);
      renderSearchTags();
      els.searchInput.value = '';
    
    } else {
      // Sinon, c'est une recherche textuelle dans le titre
      searchText = val;
    }
    
    renderCourses();
  }
};

// Recherche en temps r√©el dans le titre (optionnel)
els.searchInput.addEventListener('input', () => {
  searchText = els.searchInput.value.trim();
  renderCourses();
});

els.clearFilters.onclick = () => {
  searchTags = [];
  searchText = '';
  searchID = '';
  els.searchInput.value = '';
  typeFilters = {
    detailed: true,
    general: true,
    plan: true,
    image: true
  };
  els.filterDetailed.checked = true;
  els.filterGeneral.checked = true;
  els.filterPlan.checked = true;
  els.filterImage.checked = true;
  renderSearchTags();
  renderCourses();
};

// Gestion des filtres par type
els.filterDetailed.addEventListener('change', (e) => {
  typeFilters.detailed = e.target.checked;
  renderCourses();
});

els.filterGeneral.addEventListener('change', (e) => {
  typeFilters.general = e.target.checked;
  renderCourses();
});

els.filterPlan.addEventListener('change', (e) => {
  typeFilters.plan = e.target.checked;
  renderCourses();
});

els.filterImage.addEventListener('change', (e) => {
  typeFilters.image = e.target.checked;
  renderCourses();
});

// Obtenir tous les auteurs uniques
function getAllAuthors() {
  const authors = new Set();
  courses.forEach(c => c.authors.forEach(a => authors.add(a)));
  return Array.from(authors).sort();
}

// Obtenir tous les th√®mes uniques
function getAllThemes() {
  const themes = new Set();
  courses.forEach(c => c.themes.forEach(t => themes.add(t)));
  return Array.from(themes).sort();
}

// Syst√®me d'autocompl√©tion pour auteurs
els.newAuthor.addEventListener('input', () => {
  const val = els.newAuthor.value.toLowerCase();
  if (!val) {
    els.authorSuggestions.classList.remove('active');
    return;
  }
  
  const allAuthors = getAllAuthors();
  const matches = allAuthors.filter(a => 
    a.toLowerCase().includes(val) && !newAuthors.includes(a)
  );
  
  if (matches.length > 0) {
    els.authorSuggestions.innerHTML = matches.map(a => 
      `<div class="suggestion-item" onclick="selectAuthor('${a}')">${a}</div>`
    ).join('');
    els.authorSuggestions.classList.add('active');
  } else {
    els.authorSuggestions.classList.remove('active');
  }
});

window.selectAuthor = function(author) {
  if (!newAuthors.includes(author)) {
    newAuthors.push(author);
    renderAuthorsList();
  }
  els.newAuthor.value = '';
  els.authorSuggestions.classList.remove('active');
};

// Syst√®me d'autocompl√©tion pour th√®mes
els.newTheme.addEventListener('input', () => {
  const val = els.newTheme.value.toLowerCase();
  if (!val) {
    els.themeSuggestions.classList.remove('active');
    return;
  }
  
  const allThemes = getAllThemes();
  const matches = allThemes.filter(t => 
    t.toLowerCase().includes(val) && !newThemes.includes(t)
  );
  
  if (matches.length > 0) {
    els.themeSuggestions.innerHTML = matches.map(t => 
      `<div class="suggestion-item" onclick="selectTheme('${t}')">${t}</div>`
    ).join('');
    els.themeSuggestions.classList.add('active');
  } else {
    els.themeSuggestions.classList.remove('active');
  }
});

window.selectTheme = function(theme) {
  if (!newThemes.includes(theme)) {
    newThemes.push(theme);
    renderThemesList();
  }
  els.newTheme.value = '';
  els.themeSuggestions.classList.remove('active');
};

// Fermer les suggestions en cliquant ailleurs
document.addEventListener('click', (e) => {
  if (!els.newAuthor.contains(e.target) && !els.authorSuggestions.contains(e.target)) {
    els.authorSuggestions.classList.remove('active');
  }
  if (!els.newTheme.contains(e.target) && !els.themeSuggestions.contains(e.target)) {
    els.themeSuggestions.classList.remove('active');
  }
});

// Formulaire
els.toggleAdd.onclick = () => {
  resetForm();
  if (els.addForm.style.display === 'flex') {
    els.addForm.style.display = 'none';
  } else {
    els.addForm.style.display = 'flex';
  }
};

els.cancelAdd.onclick = () => {
  if ((els.newContent.value=="" && els.newTitle.value=="" && els.newAuthor.value=="" && els.imageInput.value == "" && newAuthors.length === 0 && newThemes.length === 0 && newLinks.length === 0) || confirm("Annuler la cr√©ation/modification de la fiche ? Les modifications non sauvegard√©es seront perdues.")) {
    resetForm();
    els.addForm.style.display = 'none';
  }
};

// Gestion du type de fiche
els.courseType.addEventListener('change', () => {
  const type = els.courseType.value;
  
  if (type === 'image') {
    els.imageUploadSection.classList.remove('hidden');
  } else {
    els.imageUploadSection.classList.add('hidden');
  }
});

// Gestion de l'upload d'image
els.imageInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (event) => {
      els.imagePreview.innerHTML = `<img src="${event.target.result}" style="max-width: 300px; border-radius: 5px;">`;
    };
    reader.readAsDataURL(file);
  }
});

function resetForm() {
  editingId = null;
  els.formTitle.textContent = "Ajouter une fiche";
  els.newTitle.value = "";
  els.newContent.value = "";
  els.courseType.value = "detailed";
  els.imageUploadSection.classList.add('hidden');
  els.imageInput.value = "";
  els.imagePreview.innerHTML = "";
  newAuthors = [];
  newThemes = [];
  newLinks = [];
  renderAuthorsList();
  renderThemesList();
  renderAddedLinks();
}

// Auteurs
function renderAuthorsList() {
  els.authorsList.innerHTML = newAuthors.map(a => `
    <span class="tag small">${a} <span class="remove" onclick="removeAuthor('${a}')">√ó</span></span>
  `).join("");
}

window.removeAuthor = function(a) {
  newAuthors = newAuthors.filter(x => x !== a);
  renderAuthorsList();
};

els.addAuthor.onclick = () => {
  const val = els.newAuthor.value.trim();
  if (val && !newAuthors.includes(val)) {
    newAuthors.push(val);
    els.newAuthor.value = "";
    renderAuthorsList();
  }
};

// Th√®mes
function renderThemesList() {
  els.themesList.innerHTML = newThemes.map(t => `
    <span class="tag small">${t} <span class="remove" onclick="removeTheme('${t}')">√ó</span></span>
  `).join("");
}

window.removeTheme = function(t) {
  newThemes = newThemes.filter(x => x !== t);
  renderThemesList();
};

els.addTheme.onclick = () => {
  const val = els.newTheme.value.trim();
  if (val && !newThemes.includes(val)) {
    newThemes.push(val);
    els.newTheme.value = "";
    renderThemesList();
  }
};

// Liens
function renderAddedLinks() {
  els.addedLinks.innerHTML = newLinks.map((link, i) => {
    const target = courses.find(c => c.id === link.targetId);
    const title = target ? target.title : `Fiche #${link.targetId}`;
    return `
      <div class="added-link">
        <span><strong>${link.type}</strong> ‚Üí #${link.targetId} ${title}</span>
        <button type="button" class="btn-icon delete" onclick="removeLink(${i})">√ó</button>
      </div>
    `;
  }).join("");
}

window.removeLink = function(i) {
  newLinks.splice(i, 1);
  renderAddedLinks();
};

els.addLink.onclick = () => {
  const type = els.linkType.value;
  const targetId = parseInt(els.linkTargetId.value);
  
  if (!targetId) {
    alert("Veuillez entrer un ID valide");
    return;
  }
  
  if (newLinks.some(l => l.targetId === targetId && l.type === type)) {
    alert("Ce lien existe d√©j√†");
    return;
  }
  
  newLinks.push({ type, targetId });
  els.linkTargetId.value = "";
  renderAddedLinks();
};

// Insertion de lien dans le texte
els.insertLinkBtn.onclick = () => {
  const id = prompt("Entrez l'ID de la fiche √† lier:");
  if (id) {
    const pos = els.newContent.selectionStart;
    const before = els.newContent.value.substring(0, pos);
    const after = els.newContent.value.substring(pos);
    els.newContent.value = before + `[${id}]` + after;
    els.newContent.focus();
  }
};

// Boutons de formatage avec d√©tection des symboles existants
function wrapSelection(before, after) {
  const start = els.newContent.selectionStart;
  const end = els.newContent.selectionEnd;
  const text = els.newContent.value;
  const selected = text.substring(start, end);
  
  // V√©rifier si le texte est d√©j√† format√©
  const beforeStart = text.substring(Math.max(0, start - before.length), start);
  const afterEnd = text.substring(end, Math.min(text.length, end + after.length));
  
  if (beforeStart === before && afterEnd === after) {
    // Retirer le formatage
    const newText = text.substring(0, start - before.length) + selected + text.substring(end + after.length);
    els.newContent.value = newText;
    els.newContent.focus();
    els.newContent.setSelectionRange(start - before.length, end - before.length);
  } else if (selected) {
    // Ajouter le formatage
    const newText = text.substring(0, start) + before + selected + after + text.substring(end);
    els.newContent.value = newText;
    els.newContent.focus();
    els.newContent.setSelectionRange(start + before.length, end + before.length);
  } else {
    // Pas de s√©lection, ajouter les symboles
    const newText = text.substring(0, start) + before + after + text.substring(start);
    els.newContent.value = newText;
    els.newContent.focus();
    els.newContent.setSelectionRange(start + before.length, start + before.length);
  }
}

els.boldBtn.onclick = () => wrapSelection('**', '**');
els.italicBtn.onclick = () => wrapSelection('*', '*');
els.underlineBtn.onclick = () => wrapSelection('__', '__');
els.citationBtn.onclick = () => wrapSelection('<<<', '>>>');
els.h3Btn.onclick = () => {
  const start = els.newContent.selectionStart;
  const text = els.newContent.value;
  const lineStart = text.lastIndexOf('\n', start - 1) + 1;
  const newText = text.substring(0, lineStart) + '### ' + text.substring(lineStart);
  els.newContent.value = newText;
  els.newContent.focus();
};

// Pr√©visualisation avant sauvegarde
els.previewCourse.onclick = () => {
  const title = els.newTitle.value.trim();
  const content = els.newContent.value.trim();
  const type = els.courseType.value;

  if (!title) {
    alert("Titre requis");
    return;
  }
  
  if (type !== 'image' && !content) {
    alert("Contenu requis");
    return;
  }

  let imageData = null;
  if (type === 'image') {
    if (editingId) {
      const oldCourse = courses.find(c => c.id === editingId);
      imageData = oldCourse?.imageData;
    }
    
    if (els.imageInput.files[0]) {
      const reader = new FileReader();
      reader.onload = (e) => {
        imageData = e.target.result;
        showPreview(title, content, type, imageData);
      };
      reader.readAsDataURL(els.imageInput.files[0]);
      return;
    } else if (!imageData) {
      alert("Veuillez s√©lectionner une image");
      return;
    }
  }
  
  showPreview(title, content, type, imageData);
};

// Afficher le modal de pr√©visualisation
function showPreview(title, content, type, imageData) {
  previewData = { title, content, type, imageData };
  
  const typeLabels = {
    general: 'üìã Fiche g√©n√©raliste',
    detailed: 'üìÑ Fiche d√©taill√©e',
    plan: 'üìù Plan d√©taill√©',
    image: 'üñºÔ∏è Image'
  };
  
  let contentHtml = `
    <div class="course-type ${type}">${typeLabels[type]}</div>
    <div class="course-id">ID: #${editingId || 'New'}</div>
    <h2 style="color: #8B4000; margin-bottom: 15px;">${title}</h2>
  `;
  
  contentHtml += `
    <div class="badges">
      ${newAuthors.map(a => `<span class="tag small author">${a}</span>`).join("")}
    </div>
    <div class="badges">
      ${newThemes.map(t => `<span class="tag small theme">${t}</span>`).join("")}
    </div>
  `;
  
  if (type === 'image' && imageData) {
    contentHtml += `<div class="image-container"><img src="${imageData}" alt="${title}"></div>`;
    if (content) {
      contentHtml += `<div class="card-content" style="margin-top: 15px;">${parseMarkdown(parseContentLinks(content)).replace(/\n/g, "<br>")}</div>`;
    }
  } else {
    contentHtml += `<div class="card-content" style="margin-top: 15px;">${parseMarkdown(parseContentLinks(content)).replace(/\n/g, "<br>")}</div>`;
  }
  
  if (newLinks.length > 0) {
    contentHtml += `
      <div class="links-section">
        <h4>üîó Liens:</h4>
        ${newLinks.map(link => {
          const target = courses.find(c => c.id === link.targetId);
          const targetTitle = target ? target.title : `Fiche #${link.targetId}`;
          return `
            <div class="link-item">
              <span class="link-type">${link.type}</span>
              <strong>#${link.targetId}</strong> ${targetTitle}
            </div>
          `;
        }).join('')}
      </div>
    `;
  }
  
  els.previewBody.innerHTML = contentHtml;
  els.addForm.style.display = 'none';
  els.previewOverlay.style.display = 'flex';
}

// Sauvegarde effective
function saveCourseData(title, content, type, imageData) {
  if (editingId) {
    const i = courses.findIndex(c => c.id === editingId);
    if (i !== -1) {
      courses[i] = {
        ...courses[i],
        type,
        title,
        content,
        imageData,
        authors: [...newAuthors],
        themes: [...newThemes],
        links: [...newLinks]
      };
    }
  } else {
    courses.push({
      id: courses.length > 0 ? Math.max(...courses.map(c => c.id)) + 1 : 1,
      type,
      title,
      content,
      imageData,
      authors: [...newAuthors],
      themes: [...newThemes],
      links: [...newLinks]
    });
  }

  saveCourses();
  resetForm();
  els.addForm.style.display = 'none';
  renderCourses();
}

// √âditer
window.editCourse = function(id) {
  const course = courses.find(c => c.id === id);
  if (!course) return;

  editingId = id;
  els.formTitle.textContent = "Modifier la fiche";
  els.newTitle.value = course.title;
  els.newContent.value = course.content || '';
  els.courseType.value = course.type || 'detailed';
  
  if (course.type === 'image') {
    els.imageUploadSection.classList.remove('hidden');
    if (course.imageData) {
      els.imagePreview.innerHTML = `<img src="${course.imageData}" style="max-width: 300px; border-radius: 5px;">`;
    }
  } else {
    els.imageUploadSection.classList.add('hidden');
  }
  
  newAuthors = [...course.authors];
  newThemes = [...course.themes];
  newLinks = course.links ? [...course.links] : [];

  renderAuthorsList();
  renderThemesList();
  renderAddedLinks();

  els.addForm.style.display = 'flex';
  window.scrollTo({ top: 0, behavior: 'smooth' });
};

// Supprimer
window.deleteCourse = function(id) {
  if (!confirm("Supprimer cette fiche ?")) return;
  courses = courses.filter(c => c.id !== id);
  saveCourses();
  renderCourses();
};

// Initialisation
renderCourses();
</script>

</body>
</html>
